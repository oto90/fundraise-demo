<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Helping Hand â€” Fundraise Up GA4 Demo</title>
  
  <!-- Google Analytics 4 - MUST load first -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-T9JS51CFMT"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag("js", new Date());
    gtag("config", "G-T9JS51CFMT");
    
    console.log("âœ… GA4 initialized");
  </script>

  <!-- Enable Test Mode BEFORE widget loads -->
  <script>
    window.fundraiseup_livemode = false;
  </script>

  <!-- Fundraise Up widget -->
  <script>
    (function (w, d, s, n, a) {
      if (!w[n]) {
        var l = "call,catch,on,once,set,then,track".split(","), i,
        o = function (n) {
          return typeof n === "function"
            ? o.l.push([arguments]) && o
            : function () { return o.l.push([n, arguments]) && o; };
        },
        t = d.getElementsByTagName(s)[0],
        j = d.createElement(s);
        j.async = true;
        j.src = "https://cdn.fundraiseup.com/widget/" + a;
        t.parentNode.insertBefore(j, t);
        o.s = Date.now();
        o.v = 4;
        o.h = w.location.href;
        o.l = [];
        for (i = 0; i < 7; i++) o[l[i]] = o(l[i]);
        w[n] = o;
      }
    })(window, document, "script", "FundraiseUp", "AEMZUDUM");
  </script>
</head>
<body>
  <h1>Helping Hand â€” Fundraise Up GA4 Demo</h1>
  
  <!-- Custom Donate Button - FundraiseUp will replace this -->
  <a href="#XJKDHSTQ" id="donate-button"></a>

  <script>
    console.log("ğŸ”§ Initializing tracking...");
    
    // Send test event
    gtag('event', 'page_ready', {
      event_category: 'test',
      event_label: 'tracking_initialized'
    });
    console.log("âœ… Test event 'page_ready' sent to GA4");

    var checkoutTracked = false;
    var donationTracked = false;

    function sendCheckoutEvent(source) {
      if (checkoutTracked) {
        console.log("âš ï¸ Checkout already tracked, skipping duplicate");
        return;
      }
      
      checkoutTracked = true;
      console.log("ğŸš€ SENDING checkout_opened from:", source);
      
      gtag('event', 'checkout_opened', {
        event_category: 'fundraiseup',
        event_label: source,
        non_interaction: false
      });
      
      console.log("âœ… checkout_opened sent to GA4");
      
      setTimeout(function() {
        checkoutTracked = false;
      }, 2000);
    }

    function sendDonationEvent(data) {
      if (donationTracked) {
        console.log("âš ï¸ Donation already tracked, skipping duplicate");
        return;
      }
      
      donationTracked = true;
      console.log("ğŸ‰ SENDING donation_completed, data:", data);
      
      gtag('event', 'donation_completed', {
        event_category: 'fundraiseup',
        event_label: 'test_donation',
        value: data && data.amount ? data.amount : 0,
        currency: data && data.currency ? data.currency : 'USD'
      });
      
      console.log("âœ… donation_completed sent to GA4");
    }

    // METHOD 1: Use FundraiseUp API (primary method)
    console.log("ğŸ” Checking FundraiseUp object:", typeof FundraiseUp, FundraiseUp);
    
    if (typeof FundraiseUp !== 'undefined') {
      // Test if the API is actually functional
      console.log("ğŸ§ª Testing FundraiseUp API methods:");
      console.log("   - FundraiseUp.on exists?", typeof FundraiseUp.on === 'function');
      
      FundraiseUp.on('checkout_open', function(data) {
        console.log("ğŸ‰ğŸ‰ğŸ‰ FundraiseUp API: checkout_open FIRED! ğŸ‰ğŸ‰ğŸ‰");
        console.log("   Data:", data);
        sendCheckoutEvent('fundraiseup_api');
      });

      FundraiseUp.on('donation_complete', function(data) {
        console.log("ğŸ‰ğŸ‰ğŸ‰ FundraiseUp API: donation_complete FIRED! ğŸ‰ğŸ‰ğŸ‰");
        console.log("   Data:", data);
        sendDonationEvent(data);
      });
      
      // Also try these alternative event names
      FundraiseUp.on('checkout_opened', function(data) {
        console.log("ğŸ‰ Alternative event: checkout_opened fired");
        sendCheckoutEvent('fundraiseup_api_alt');
      });
      
      FundraiseUp.on('open', function(data) {
        console.log("ğŸ‰ Alternative event: open fired");
        sendCheckoutEvent('fundraiseup_open');
      });

      console.log("âœ… FundraiseUp API event handlers registered");
      console.log("   Registered events: checkout_open, donation_complete, checkout_opened, open");
    } else {
      console.error("âŒ FundraiseUp object not found!");
    }

    // METHOD 2: Watch for FundraiseUp widget button to appear and track clicks
    var observer = new MutationObserver(function(mutations) {
      // Look for FundraiseUp buttons in the page
      var fundraiseButtons = document.querySelectorAll('[data-fundraiseup-id], [href*="XJKDHSTQ"], button[class*="fundraise"], a[class*="fundraise"]');
      
      fundraiseButtons.forEach(function(btn) {
        if (btn.dataset.tracked) return; // Already tracking this button
        
        btn.dataset.tracked = 'true';
        console.log("ğŸ” Found FundraiseUp button, attaching listeners:", btn);
        
        ['mousedown', 'click'].forEach(function(eventType) {
          btn.addEventListener(eventType, function(e) {
            console.log("ğŸ–±ï¸ FundraiseUp button " + eventType.toUpperCase());
            sendCheckoutEvent('widget_button_' + eventType);
          }, true);
        });
      });
    });

    observer.observe(document.body, {
      childList: true,
      subtree: true,
      attributes: true
    });
    console.log("âœ… DOM mutation observer started - watching for FundraiseUp buttons");

    // METHOD 3: Fallback - track ALL clicks and check if they're opening the modal
    var modalCheckInterval;
    var clickCount = 0;
    document.addEventListener('click', function(e) {
      clickCount++;
      console.log("ğŸ–±ï¸ CLICK #" + clickCount + " detected on:", e.target.tagName, e.target.className, e.target.id);
      console.log("   Full element:", e.target);
      
      // After any click, check if a modal appeared
      clearTimeout(modalCheckInterval);
      modalCheckInterval = setTimeout(function() {
        var modals = document.querySelectorAll('[class*="modal"], [class*="overlay"], [role="dialog"], iframe[src*="fundraiseup"]');
        console.log("   Checking for modals... found:", modals.length);
        if (modals.length > 0) {
          console.log("ğŸ‘ï¸ Modal detected after click!");
          sendCheckoutEvent('modal_detected');
        }
      }, 100);
    }, true);
    console.log("âœ… Global click listener with modal detection active - will log EVERY click");

    // METHOD 4: Monitor for iframe (FundraiseUp checkout opens in iframe)
    var iframeCheckCount = 0;
    var iframeFound = false;
    setInterval(function() {
      iframeCheckCount++;
      var iframes = document.querySelectorAll('iframe');
      
      if (iframeCheckCount % 10 === 0) {
        console.log("ğŸ” Iframe check #" + iframeCheckCount + " - Total iframes:", iframes.length);
      }
      
      if (iframes.length > 0 && !iframeFound) {
        iframeFound = true;
        console.log("ğŸ¯ğŸ¯ğŸ¯ IFRAME DETECTED! ğŸ¯ğŸ¯ğŸ¯");
        iframes.forEach(function(iframe, index) {
          console.log("   Iframe #" + index + " src:", iframe.src);
        });
        sendCheckoutEvent('iframe_detected');
        
        // Reset after 5 seconds so we can detect if user closes and reopens
        setTimeout(function() {
          iframeFound = false;
        }, 5000);
      }
    }, 500);
    console.log("âœ… Iframe monitoring started - checking every 500ms");
  </script>

  <!-- Debug panel -->
  <div style="margin-top: 40px; padding: 20px; background: #f5f5f5; border-radius: 8px; font-family: monospace; font-size: 12px;">
    <h3 style="margin-top: 0;">ğŸ” Debug Info</h3>
    <p><strong>GA4 Property:</strong> G-T9JS51CFMT</p>
    <p><strong>Test Mode:</strong> Enabled</p>
    <p><strong>Form ID:</strong> XJKDHSTQ</p>
    
    <div style="background: white; padding: 12px; border-radius: 4px; margin-top: 12px;">
      <p style="margin: 0 0 8px 0; font-weight: bold; color: #d32f2f;">ğŸ” Discovery: Your button is being removed!</p>
      <p style="margin: 8px 0;">FundraiseUp replaces <code>&lt;a href="#XJKDHSTQ"&gt;</code> with their own widget button. We're now tracking their button instead.</p>
      
      <p style="margin: 12px 0 8px 0; font-weight: bold;">Expected behavior:</p>
      <ol style="margin: 0; padding-left: 20px; line-height: 1.6;">
        <li>Widget button appears (green)</li>
        <li>Click it â†’ should log button click + modal/iframe detection</li>
        <li>checkout_opened event fires to GA4</li>
        <li>Complete donation â†’ donation_completed fires to GA4</li>
      </ol>
    </div>

    <p style="margin-top: 12px; color: #d32f2f;"><strong>âš ï¸ Watch the console when you click the donate button!</strong></p>
  </div>
</body>
</html>
