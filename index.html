<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Helping Hand â€” Fundraise Up GA4 Demo</title>
  
  <!-- Google Analytics 4 - MUST load first -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-T9JS51CFMT"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag("js", new Date());
    gtag("config", "G-T9JS51CFMT");
    
    console.log("âœ… GA4 initialized");
  </script>

  <!-- Enable Test Mode BEFORE widget loads -->
  <script>
    window.fundraiseup_livemode = false;
  </script>

  <!-- Fundraise Up widget -->
  <script>
    (function (w, d, s, n, a) {
      if (!w[n]) {
        var l = "call,catch,on,once,set,then,track".split(","), i,
        o = function (n) {
          return typeof n === "function"
            ? o.l.push([arguments]) && o
            : function () { return o.l.push([n, arguments]) && o; };
        },
        t = d.getElementsByTagName(s)[0],
        j = d.createElement(s);
        j.async = true;
        j.src = "https://cdn.fundraiseup.com/widget/" + a;
        t.parentNode.insertBefore(j, t);
        o.s = Date.now();
        o.v = 4;
        o.h = w.location.href;
        o.l = [];
        for (i = 0; i < 7; i++) o[l[i]] = o(l[i]);
        w[n] = o;
      }
    })(window, document, "script", "FundraiseUp", "AEMZUDUM");
  </script>
</head>
<body>
  <h1>Helping Hand â€” Fundraise Up GA4 Demo</h1>
  
  <!-- Custom Donate Button - FundraiseUp will replace this -->
  <a href="#XJKDHSTQ" id="donate-button"></a>

  <script>
    console.log("ğŸ”§ Initializing dataLayer event tracking...");
    
    // Send test event
    gtag('event', 'page_ready', {
      event_category: 'test',
      event_label: 'tracking_initialized'
    });
    console.log("âœ… Test event 'page_ready' sent to GA4");

    // SOLUTION: Listen for FundraiseUp events pushed to dataLayer
    // Save the original push function
    var originalPush = window.dataLayer.push;
    
    // Override dataLayer.push to intercept FundraiseUp events
    window.dataLayer.push = function() {
      // Call the original push
      var result = originalPush.apply(window.dataLayer, arguments);
      
      // Check what was pushed
      var data = arguments[0];
      
      if (data && typeof data === 'object') {
        console.log("ğŸ“¦ dataLayer event:", data.event, data);
        
        // Listen for FundraiseUp.checkoutOpen event (note the capital O and the prefix)
        if (data.event === 'FundraiseUp.checkoutOpen') {
          console.log("ğŸ‰ğŸ‰ğŸ‰ CHECKOUT OPENED via dataLayer! ğŸ‰ğŸ‰ğŸ‰");
          console.log("   Event data:", data);
          
          gtag('event', 'checkout_opened', {
            event_category: 'fundraiseup',
            event_label: 'checkout_modal_opened',
            non_interaction: false
          });
          
          console.log("âœ… checkout_opened sent to GA4");
        }
        
        // Listen for FundraiseUp.donationComplete event
        if (data.event === 'FundraiseUp.donationComplete') {
          console.log("ğŸ‰ğŸ‰ğŸ‰ DONATION COMPLETED via dataLayer! ğŸ‰ğŸ‰ğŸ‰");
          console.log("   Event data:", data);
          
          // Extract amount from the correct location in the FundraiseUp data structure
          var amount = 0;
          var currency = 'USD';
          
          // Try multiple possible locations for amount
          if (data.FundraiseUp && data.FundraiseUp.donation && data.FundraiseUp.donation.amount) {
            amount = data.FundraiseUp.donation.amount;
          } else if (data.ecommerce && data.ecommerce.purchase && data.ecommerce.purchase.actionField) {
            amount = data.ecommerce.purchase.actionField.revenue || data.ecommerce.purchase.actionField.value || 0;
          }
          
          // Extract currency
          if (data.FundraiseUp && data.FundraiseUp.donation && data.FundraiseUp.donation.currency) {
            currency = data.FundraiseUp.donation.currency;
          } else if (data.ecommerce && data.ecommerce.currencyCode) {
            currency = data.ecommerce.currencyCode;
          }
          
          console.log("   Extracted amount:", amount, currency);
          
          gtag('event', 'donation_completed', {
            event_category: 'fundraiseup',
            event_label: 'test_donation',
            value: amount,
            currency: currency
          });
          
          console.log("âœ… donation_completed sent to GA4 (amount: " + amount + " " + currency + ")");
        }
        
        // Listen for FundraiseUp.checkoutClose event (optional, for debugging)
        if (data.event === 'FundraiseUp.checkoutClose') {
          console.log("â„¹ï¸ Checkout closed via dataLayer");
        }
      }
      
      return result;
    };
    
    console.log("âœ… dataLayer event listener installed");
    console.log("   Watching for: FundraiseUp.checkoutOpen, FundraiseUp.donationComplete, FundraiseUp.checkoutClose");
  </script>

  <!-- Debug panel -->
  <div style="margin-top: 40px; padding: 20px; background: #f5f5f5; border-radius: 8px; font-family: monospace; font-size: 12px;">
    <h3 style="margin-top: 0;">ğŸ” Debug Info</h3>
    <p><strong>GA4 Property:</strong> G-T9JS51CFMT</p>
    <p><strong>Test Mode:</strong> Enabled</p>
    <p><strong>Form ID:</strong> XJKDHSTQ</p>
    
    <div style="background: white; padding: 12px; border-radius: 4px; margin-top: 12px;">
      <p style="margin: 0 0 8px 0; font-weight: bold; color: #4caf50;">âœ… Solution: dataLayer Event Listening</p>
      <p style="margin: 8px 0;">FundraiseUp pushes events to the dataLayer. We're now intercepting those events and forwarding them to GA4.</p>
      
      <p style="margin: 12px 0 8px 0; font-weight: bold;">Expected behavior:</p>
      <ol style="margin: 0; padding-left: 20px; line-height: 1.6;">
        <li>Click donate button</li>
        <li>See "ğŸ‰ CHECKOUT OPENED via dataLayer!" in console</li>
        <li>See checkout_opened in GA4 Realtime</li>
        <li>Complete donation</li>
        <li>See "ğŸ‰ DONATION COMPLETED via dataLayer!" in console</li>
        <li>See donation_completed in GA4 Realtime</li>
      </ol>
    </div>

    <p style="margin-top: 12px; color: #d32f2f;"><strong>âš ï¸ Watch the console for dataLayer events!</strong></p>
    <p style="margin: 8px 0;">Every dataLayer push will be logged with "ğŸ“¦ dataLayer event:"</p>
  </div>
</body>
</html>
