<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Helping Hand ‚Äî Fundraise Up GA4 Demo</title>
  
  <!-- Google Analytics 4 - MUST load first -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-T9JS51CFMT"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag("js", new Date());
    gtag("config", "G-T9JS51CFMT");
    
    console.log("‚úÖ GA4 initialized");
  </script>

  <!-- Enable Test Mode BEFORE widget loads -->
  <script>
    window.fundraiseup_livemode = false;
  </script>

  <!-- Fundraise Up widget -->
  <script>
    (function (w, d, s, n, a) {
      if (!w[n]) {
        var l = "call,catch,on,once,set,then,track".split(","), i,
        o = function (n) {
          return typeof n === "function"
            ? o.l.push([arguments]) && o
            : function () { return o.l.push([n, arguments]) && o; };
        },
        t = d.getElementsByTagName(s)[0],
        j = d.createElement(s);
        j.async = true;
        j.src = "https://cdn.fundraiseup.com/widget/" + a;
        t.parentNode.insertBefore(j, t);
        o.s = Date.now();
        o.v = 4;
        o.h = w.location.href;
        o.l = [];
        for (i = 0; i < 7; i++) o[l[i]] = o(l[i]);
        w[n] = o;
      }
    })(window, document, "script", "FundraiseUp", "AEMZUDUM");
  </script>
</head>
<body>
  <h1>Helping Hand ‚Äî Fundraise Up GA4 Demo</h1>
  
  <!-- Custom Donate Button -->
  <a href="#XJKDHSTQ" id="donate-button" style="display: inline-block; padding: 12px 24px; background: #2196F3; color: white; text-decoration: none; border-radius: 4px; font-weight: bold;">Donate Now</a>

  <script>
    // Track ALL checkout events - both from button clicks AND FundraiseUp API
    var checkoutTracked = false; // Prevent duplicate tracking

    function sendCheckoutEvent(source) {
      if (checkoutTracked) {
        console.log("‚ö†Ô∏è Checkout already tracked, skipping duplicate");
        return;
      }
      
      checkoutTracked = true;
      console.log("üöÄ SENDING checkout_opened from:", source);
      
      // Send to GA4
      gtag('event', 'checkout_opened', {
        event_category: 'fundraiseup',
        event_label: source,
        non_interaction: false
      });
      
      console.log("‚úÖ checkout_opened sent to GA4");
      
      // Reset after 2 seconds (in case user closes and reopens)
      setTimeout(function() {
        checkoutTracked = false;
      }, 2000);
    }

    function sendDonationEvent(data) {
      console.log("üéâ SENDING donation_completed, data:", data);
      
      gtag('event', 'donation_completed', {
        event_category: 'fundraiseup',
        event_label: 'test_donation',
        value: data && data.amount ? data.amount : 0,
        currency: data && data.currency ? data.currency : 'USD'
      });
      
      console.log("‚úÖ donation_completed sent to GA4");
    }

    // Wait for DOM to be ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initTracking);
    } else {
      initTracking();
    }

    function initTracking() {
      console.log("üîß Initializing tracking...");

      // Test event to verify GA4 is receiving custom events
      gtag('event', 'page_ready', {
        event_category: 'test',
        event_label: 'tracking_initialized'
      });
      console.log("‚úÖ Test event 'page_ready' sent to GA4");

      // METHOD 1: Track direct button clicks (works for custom blue button)
      var donateBtn = document.getElementById('donate-button');
      if (donateBtn) {
        donateBtn.addEventListener('click', function(e) {
          console.log("üñ±Ô∏è Blue button clicked");
          sendCheckoutEvent('blue_button_click');
        });
        console.log("‚úÖ Click listener attached to blue donate button");
      }

      // METHOD 2: Track ANY link with href="#XJKDHSTQ"
      document.addEventListener('click', function(e) {
        var target = e.target;
        // Check if clicked element or any parent is a link to #XJKDHSTQ
        while (target && target !== document) {
          if (target.tagName === 'A' && target.getAttribute('href') === '#XJKDHSTQ') {
            console.log("üñ±Ô∏è FundraiseUp link clicked (href=#XJKDHSTQ)");
            sendCheckoutEvent('fundraiseup_link_click');
            break;
          }
          target = target.parentElement;
        }
      });
      console.log("‚úÖ Global click listener attached for all #XJKDHSTQ links");

      // METHOD 3: Use FundraiseUp API events (if they fire)
      if (typeof FundraiseUp !== 'undefined') {
        
        // Track checkout open via API
        FundraiseUp.on('checkout_open', function(data) {
          console.log("üì¢ FundraiseUp API: checkout_open fired", data);
          sendCheckoutEvent('fundraiseup_api');
        });

        // Track donation complete
        FundraiseUp.on('donation_complete', function(data) {
          console.log("üì¢ FundraiseUp API: donation_complete fired", data);
          sendDonationEvent(data);
        });

        console.log("‚úÖ FundraiseUp API event handlers registered");
      }

      // METHOD 4: Watch for modal appearing in DOM (nuclear option)
      var observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          mutation.addedNodes.forEach(function(node) {
            if (node.nodeType === 1) {
              // Check if this looks like a FundraiseUp modal
              if (node.classList && (
                  node.classList.contains('fu-modal') || 
                  node.classList.contains('fundraiseup-modal') ||
                  (node.id && node.id.includes('fundraise'))
                )) {
                console.log("üëÅÔ∏è Modal detected in DOM:", node);
                sendCheckoutEvent('dom_mutation_observer');
              }
            }
          });
        });
      });

      observer.observe(document.body, {
        childList: true,
        subtree: true
      });
      console.log("‚úÖ DOM mutation observer started");
    }
  </script>

  <!-- Debug panel -->
  <div style="margin-top: 40px; padding: 20px; background: #f5f5f5; border-radius: 8px; font-family: monospace; font-size: 12px;">
    <h3 style="margin-top: 0;">üîç Debug Info</h3>
    <p><strong>GA4 Property:</strong> G-T9JS51CFMT</p>
    <p><strong>Test Mode:</strong> Enabled</p>
    <p><strong>Form ID:</strong> XJKDHSTQ</p>
    
    <div style="background: white; padding: 12px; border-radius: 4px; margin-top: 12px;">
      <p style="margin: 0 0 8px 0; font-weight: bold;">Expected Console Logs:</p>
      <ol style="margin: 0; padding-left: 20px; line-height: 1.6;">
        <li>‚úÖ GA4 initialized</li>
        <li>üîß Initializing tracking...</li>
        <li>‚úÖ Test event 'page_ready' sent</li>
        <li>‚úÖ Click listeners attached</li>
        <li><strong style="color: #2196F3;">When you click donate:</strong>
          <ul style="margin: 4px 0;">
            <li>üñ±Ô∏è Button clicked</li>
            <li>üöÄ SENDING checkout_opened</li>
            <li>‚úÖ checkout_opened sent to GA4</li>
          </ul>
        </li>
        <li><strong style="color: #4caf50;">After completing donation:</strong>
          <ul style="margin: 4px 0;">
            <li>üéâ SENDING donation_completed</li>
            <li>‚úÖ donation_completed sent to GA4</li>
          </ul>
        </li>
      </ol>
    </div>

    <p style="margin-top: 12px; color: #d32f2f;"><strong>‚ö†Ô∏è IMPORTANT: Check browser console for logs!</strong></p>
    <p style="margin: 8px 0;">Open GA4 <strong>Realtime ‚Üí Events</strong> within 30 seconds to see events appear.</p>
  </div>
</body>
</html>
